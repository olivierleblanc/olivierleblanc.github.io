<div class="figure-div">
    <figure>
        
        <img src="/assets/images/posts/local-dynamodb-stream/header.jpg" alt="dynamodb-stream-header" />
        
        
            <figcaption>Simple application</figcaption>
        
    </figure>
</div>

<h2 id="introduction">Introduction</h2>

<p>We’ll explore how you can create a simple application that implements DynamoDB 
Stream, Lambda function, and S3 in a local setup. The goal of this article 
is to show you how you can play with AWS services locally, explore 
their features, and build local tests for your application.</p>

<p>In order to follow the examples in this article you’ll need python, AWS CLI and 
Docker.</p>

<blockquote>
  <p>If you don’t have them already installed, please see:</p>
  <ul>
    <li><a href="https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html" target="_blank">Installing or updating the latest version of the AWS CLI</a></li>
    <li><a href="https://docs.docker.com/get-docker/" target="_blank">Get Docker</a></li>
    <li><a href="https://realpython.com/installing-python/" target="_blank">Python 3 Installation &amp; Setup Guide</a></li>
  </ul>
</blockquote>

<p>We will see how to set up a connection between a DynamoDB Stream and a Lambda 
function that will process stream events and output results to an S3 bucket using 
<a href="https://localstack.cloud/" target="_blank">localstack</a>, 
which is a fully functional local cloud stack that let’s you easily develop 
and test your cloud and serverless applications locally.</p>

<p>There are multiple ways to approach this setup. In this article we will cover 
two of them:</p>
<ul>
  <li>using AWS CLI and</li>
  <li>through code - AWS SDK for Python: 
<a href="https://boto3.amazonaws.com/v1/documentation/api/latest/index.html" target="_blank">boto3</a>.</li>
</ul>

<h3 id="cli">CLI</h3>

<p>Run the localstack docker image using:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">--rm</span> <span class="nt">-it</span> <span class="nt">-p</span> 4566:4566 <span class="nt">-p</span> 4571:4571 localstack/localstack
</code></pre></div></div>

<p>If everything goes well you should see <code class="language-plaintext highlighter-rouge">INFO</code> log stating: 
<code class="language-plaintext highlighter-rouge">Execution of "start_runtime_components" took XYZms</code>. Now, that the 
localstack is up and running we can create a DynamoDB table:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># AWS CLI requires the following parameters</span>
<span class="nb">export </span><span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span><span class="s2">"something"</span>
<span class="nb">export </span><span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span><span class="s2">"something"</span>
<span class="nb">export </span><span class="nv">AWS_DEFAULT_REGION</span><span class="o">=</span>us-west-1

aws dynamodb create-table <span class="se">\</span>
  <span class="nt">--endpoint-url</span> http://localhost:4566 <span class="se">\</span>
  <span class="nt">--region</span><span class="o">=</span>us-west-1 <span class="se">\</span>
  <span class="nt">--billing-mode</span> PAY_PER_REQUEST <span class="se">\</span>
  <span class="nt">--table-name</span> TestTable <span class="se">\</span>
  <span class="nt">--attribute-definitions</span> <span class="nv">AttributeName</span><span class="o">=</span>PartitionKey,AttributeType<span class="o">=</span>S <span class="se">\</span>
  <span class="nt">--key-schema</span> <span class="nv">AttributeName</span><span class="o">=</span>PartitionKey,KeyType<span class="o">=</span>HASH <span class="se">\</span>
  <span class="nt">--stream-specification</span> <span class="nv">StreamEnabled</span><span class="o">=</span><span class="nb">true</span>,StreamViewType<span class="o">=</span>NEW_AND_OLD_IMAGES
</code></pre></div></div>

<p>To confirm that our table has been successfully created we can run:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aws dynamodb describe-table <span class="se">\</span>
    <span class="nt">--endpoint-url</span> http://localhost:4566 <span class="se">\</span>
    <span class="nt">--region</span><span class="o">=</span>us-west-1 <span class="se">\</span>
    <span class="nt">--table-name</span><span class="o">=</span>TestTable
</code></pre></div></div>

<p>and the output should look like:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">{</span>
    <span class="s2">"Table"</span>: <span class="o">{</span>
        <span class="s2">"AttributeDefinitions"</span>: <span class="o">[</span>
            <span class="o">{</span>
                <span class="s2">"AttributeName"</span>: <span class="s2">"PartitionKey"</span>,
                <span class="s2">"AttributeType"</span>: <span class="s2">"S"</span>
            <span class="o">}</span>
        <span class="o">]</span>,
        <span class="s2">"TableName"</span>: <span class="s2">"TestTable"</span>,
        <span class="s2">"KeySchema"</span>: <span class="o">[</span>
            <span class="o">{</span>
                <span class="s2">"AttributeName"</span>: <span class="s2">"PartitionKey"</span>,
                <span class="s2">"KeyType"</span>: <span class="s2">"HASH"</span>
            <span class="o">}</span>
        <span class="o">]</span>,
        <span class="s2">"TableStatus"</span>: <span class="s2">"ACTIVE"</span>,
        <span class="s2">"CreationDateTime"</span>: <span class="s2">"2022-02-27T18:17:38.893000+01:00"</span>,
        <span class="s2">"ProvisionedThroughput"</span>: <span class="o">{</span>
            <span class="s2">"LastIncreaseDateTime"</span>: <span class="s2">"1970-01-01T01:00:00+01:00"</span>,
            <span class="s2">"LastDecreaseDateTime"</span>: <span class="s2">"1970-01-01T01:00:00+01:00"</span>,
            <span class="s2">"NumberOfDecreasesToday"</span>: 0,
            <span class="s2">"ReadCapacityUnits"</span>: 0,
            <span class="s2">"WriteCapacityUnits"</span>: 0
        <span class="o">}</span>,
        <span class="s2">"TableSizeBytes"</span>: 0,
        <span class="s2">"ItemCount"</span>: 0,
        <span class="s2">"TableArn"</span>: <span class="s2">"arn:aws:dynamodb:us-west-1:000000000000:table/TestTable"</span>,
        <span class="s2">"TableId"</span>: <span class="s2">"193244b5-1713-4b0e-878f-aef94a1a707d"</span>,
        <span class="s2">"BillingModeSummary"</span>: <span class="o">{</span>
            <span class="s2">"BillingMode"</span>: <span class="s2">"PAY_PER_REQUEST"</span>,
            <span class="s2">"LastUpdateToPayPerRequestDateTime"</span>: <span class="s2">"2022-02-27T18:17:38.893000+01:00"</span>
        <span class="o">}</span>,
        <span class="s2">"StreamSpecification"</span>: <span class="o">{</span>
            <span class="s2">"StreamEnabled"</span>: <span class="nb">true</span>,
            <span class="s2">"StreamViewType"</span>: <span class="s2">"NEW_AND_OLD_IMAGES"</span>
        <span class="o">}</span>,
        <span class="s2">"LatestStreamLabel"</span>: <span class="s2">"2022-02-27T17:17:38.893"</span>,
        <span class="s2">"LatestStreamArn"</span>: <span class="s2">"arn:aws:dynamodb:us-west-1:000000000000:table/TestTable/stream/2022-02-27T17:17:38.893"</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Next we will create an S3 bucket, using 
<a href="https://docs.aws.amazon.com/cli/latest/reference/s3api/create-bucket.html" target="_blank"><code class="language-plaintext highlighter-rouge">create-bucket</code></a>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aws s3api create-bucket <span class="se">\</span>
  <span class="nt">--region</span> us-west-1 <span class="se">\</span>
  <span class="nt">--endpoint-url</span> http://localhost:4566 <span class="se">\</span>
  <span class="nt">--bucket</span> test-bucket
</code></pre></div></div>

<p>In order to use a Lambda function with DynamoDB Stream we first have to 
create an IAM role and put role policy using: 
<a href="https://docs.aws.amazon.com/cli/latest/reference/iam/create-role.html" target="_blank"><code class="language-plaintext highlighter-rouge">create-role</code></a> 
and <a href="https://docs.aws.amazon.com/cli/latest/reference/iam/put-role-policy.html" target="_blank"><code class="language-plaintext highlighter-rouge">put-role-policy</code></a>.</p>

<p>Creating role requires a trust relationship policy document in a JSON file:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"Principal"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"Service"</span><span class="p">:</span><span class="w"> </span><span class="s2">"lambda.amazonaws.com"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sts:AssumeRole"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
 </span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Then run the <code class="language-plaintext highlighter-rouge">create_role</code> command as:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> aws iam create-role <span class="se">\</span>
  <span class="nt">--region</span> us-west-1 <span class="se">\</span>
  <span class="nt">--endpoint-url</span> http://localhost:4566 <span class="se">\</span>
  <span class="nt">--role-name</span> LambdaRole <span class="se">\</span>
  <span class="nt">--path</span> <span class="s2">"/service-role/"</span> <span class="se">\</span>
  <span class="nt">--assume-role-policy-document</span> file://trust-relationship.json
</code></pre></div></div>

<p>We need to add an inline policy document to the IAM role, this will require 
a policy document that will allow a Lambda function to access DynamoDB Stream, 
S3 and create logs in CloudWatch:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2021-01-01"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"lambda:InvokeFunction"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"arn:aws:lambda:us-west-1:0000000000:function:ddb_stream_listener*"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="s2">"logs:CreateLogGroup"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"logs:CreateLogStream"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"logs:PutLogEvents"</span><span class="w">
            </span><span class="p">],</span><span class="w">
            </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"arn:aws:logs:us-west-1:0000000000:*"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="s2">"dynamodb:DescribeStream"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"dynamodb:GetRecords"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"dynamodb:GetShardIterator"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"dynamodb:ListStreams"</span><span class="w">
            </span><span class="p">],</span><span class="w">
            </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"arn:aws:dynamodb:us-west-1:0000000000:table/TestTable/stream/*"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="s2">"s3:PutObject"</span><span class="w">
            </span><span class="p">],</span><span class="w">
            </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"arn:aws:s3:us-west-1:0000000000:test-bucket/*"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>The following command will create an inline policy for the role:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aws iam put-role-policy <span class="se">\</span>
  <span class="nt">--region</span> us-west-1 <span class="se">\</span>
  <span class="nt">--endpoint-url</span> http://localhost:4566 <span class="se">\</span>
  <span class="nt">--role-name</span> LambdaRole <span class="se">\</span>
  <span class="nt">--policy-name</span> LambdaRolePolicy <span class="se">\</span>
  <span class="nt">--policy-document</span> file://role-policy.json
</code></pre></div></div>

<p>Since required policies are now in place, we can create a Lambda function 
handler that will log the event and create a file in the S3 bucket:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">boto3</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="p">.</span><span class="n">getLogger</span><span class="p">()</span>
<span class="n">logger</span><span class="p">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="p">.</span><span class="n">INFO</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="s">"""Simple Lambda handler"""</span>
    <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">'Event: %s'</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">bucket_name</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="s">"BUCKET_NAME"</span><span class="p">]</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="p">.</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">event</span><span class="p">[</span><span class="s">"Records"</span><span class="p">]:</span>
            <span class="n">records</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">record</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">records</span><span class="p">:</span>
            <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Writing records to: %s"</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
            <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Number fo records: %d"</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">records</span><span class="p">))</span>
            <span class="n">s3</span> <span class="o">=</span> <span class="n">boto3</span><span class="p">.</span><span class="n">resource</span><span class="p">(</span>
                <span class="s">"s3"</span><span class="p">,</span> 
                <span class="n">endpoint_url</span><span class="o">=</span><span class="s">'http://localhost:4566'</span><span class="p">,</span>
                <span class="n">aws_access_key_id</span> <span class="o">=</span> <span class="s">'something'</span><span class="p">,</span>
                <span class="n">aws_secret_access_key</span> <span class="o">=</span> <span class="s">'something'</span>
            <span class="p">)</span>
            <span class="n">s3</span><span class="p">.</span><span class="n">Bucket</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">).</span><span class="n">put_object</span><span class="p">(</span><span class="n">Key</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span> <span class="n">Body</span><span class="o">=</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">records</span><span class="p">))</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="s">"An error occured: %s"</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</code></pre></div></div>

<p>In order to use this handler and upload it as a function we have to first zip 
it and then create a lambda function using: 
<a href="https://docs.aws.amazon.com/cli/latest/reference/lambda/create-function.html" target="_blank"><code class="language-plaintext highlighter-rouge">create-function</code></a></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>zip lambda_handler.zip lambda_handler.py

aws lambda create-function <span class="se">\</span>
  <span class="nt">--endpoint-url</span> http://localhost:4566 <span class="se">\</span>
  <span class="nt">--function-name</span> test-lambda-function <span class="se">\</span>
  <span class="nt">--zip-file</span> fileb://lambda_handler.zip <span class="se">\</span>
  <span class="nt">--handler</span> lambda_handler.handler <span class="se">\</span>
  <span class="nt">--runtime</span> python3.8 <span class="se">\</span>
  <span class="nt">--environment</span> <span class="nv">Variables</span><span class="o">={</span><span class="nv">BUCKET_NAME</span><span class="o">=</span>test-bucket<span class="o">}</span> <span class="se">\</span>
  <span class="nt">--role</span> arn:aws:iam::000000000000:role/LambdaRole
</code></pre></div></div>

<p>The only thing that is left is to create an event source mapping for the Lambda 
function. For this we need the DynamoDB Stream ARN of our stream, which we can 
get by listing DynamoDB Streams using: 
<a href="https://docs.aws.amazon.com/cli/latest/reference/dynamodbstreams/list-streams.html" target="_blank"><code class="language-plaintext highlighter-rouge">list-streams</code></a></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aws dynamodbstreams list-streams <span class="se">\</span>
  <span class="nt">--endpoint-url</span> http://localhost:4566 <span class="se">\</span>
  <span class="nt">--table-name</span> TestTable
</code></pre></div></div>

<p>you should see an output like:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "Streams": [
        {
            "StreamArn": "arn:aws:dynamodb:us-west-1:000000000000:table/TestTable/stream/2022-02-27T17:17:38.893",
            "TableName": "TestTable",
            "StreamLabel": "2022-02-27T17:17:38.893"
        }
    ]
}
</code></pre></div></div>

<p>Now, we can create a source mapping using 
<a href="https://docs.aws.amazon.com/cli/latest/reference/lambda/create-event-source-mapping.html" target="_blank"><code class="language-plaintext highlighter-rouge">create-event-source-mapping</code></a></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aws lambda create-event-source-mapping <span class="se">\</span>
  <span class="nt">--region</span> us-west-1 <span class="se">\</span>
  <span class="nt">--endpoint-url</span> http://localhost:4566  <span class="se">\</span>
  <span class="nt">--function-name</span> test-lambda-function <span class="se">\</span>
  <span class="nt">--event-source</span> arn:aws:dynamodb:us-west-1:000000000000:table/TestTable/stream/2022-02-27T17:17:38.893 <span class="se">\</span>
  <span class="nt">--batch-size</span> 10 <span class="se">\</span>
  <span class="nt">--starting-position</span> TRIM_HORIZON
</code></pre></div></div>

<p>Finally, we can test the setup by inserting an item into DynamoDB table:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aws dynamodb put-item <span class="se">\</span>
  <span class="nt">--endpoint-url</span> http://localhost:4566 <span class="se">\</span>
  <span class="nt">--table-name</span> TestTable  <span class="se">\</span>
  <span class="nt">--item</span> <span class="se">\</span>
      <span class="s1">'{"PartitionKey": {"S": "random-key"}, "Value": {"S": "SomethingRandom"}}'</span>
</code></pre></div></div>

<p>and if everything goes well you should see a file in the S3 bucket:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aws s3api list-objects <span class="se">\</span>
  <span class="nt">--endpoint-url</span> http://localhost:4566 <span class="se">\</span>
  <span class="nt">--bucket</span> test-bucket
</code></pre></div></div>

<h3 id="python">Python</h3>

<p>The same can be done through python code using boto3 service clients. First we 
define environment variables, clients and helper functions:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">boto3</span>


<span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="s">"AWS_SECRET_ACCESS_KEY"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"something"</span>
<span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="s">"AWS_ACCESS_KEY_ID"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"something"</span>
<span class="n">ENDPOINT_URL</span> <span class="o">=</span> <span class="s">"http://localhost:4566"</span>
<span class="n">AWS_REGION</span> <span class="o">=</span> <span class="s">"us-west-1"</span>

<span class="k">def</span> <span class="nf">read_policy_document</span><span class="p">(</span><span class="n">document</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="s">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">policy_document</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">policy_document</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_boto3_client</span><span class="p">(</span><span class="n">service</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">boto3</span><span class="p">.</span><span class="n">client</span><span class="p">(</span>
        <span class="n">service</span><span class="p">,</span>
        <span class="n">region_name</span><span class="o">=</span><span class="n">AWS_REGION</span><span class="p">,</span> 
        <span class="n">endpoint_url</span><span class="o">=</span><span class="n">ENDPOINT_URL</span>
    <span class="p">)</span>

<span class="n">s3_client</span> <span class="o">=</span> <span class="n">get_boto3_client</span><span class="p">(</span><span class="s">"s3"</span><span class="p">)</span>
<span class="n">ddb_client</span> <span class="o">=</span> <span class="n">get_boto3_client</span><span class="p">(</span><span class="s">"dynamodb"</span><span class="p">)</span>
<span class="n">lambda_client</span> <span class="o">=</span> <span class="n">get_boto3_client</span><span class="p">(</span><span class="s">"lambda"</span><span class="p">)</span>
<span class="n">iam_client</span> <span class="o">=</span> <span class="n">get_boto3_client</span><span class="p">(</span><span class="s">"iam"</span><span class="p">)</span>
<span class="n">ddb_streams_client</span> <span class="o">=</span> <span class="n">get_boto3_client</span><span class="p">(</span><span class="s">"dynamodbstreams"</span><span class="p">)</span>
</code></pre></div></div>

<p>then for each service we create functions that will do the same as AWS CLI 
commands.</p>

<p>DynamoDB:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">create_dynamodb_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">):</span>
    <span class="s">"""Creates a DynamoDB table with stream enabled"""</span>
    <span class="k">return</span> <span class="n">ddb_client</span><span class="p">.</span><span class="n">create_table</span><span class="p">(</span>
        <span class="n">TableName</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span>
        <span class="n">KeySchema</span><span class="o">=</span><span class="p">[</span>
            <span class="p">{</span>
                <span class="s">'AttributeName'</span><span class="p">:</span> <span class="s">'PartitionKey'</span><span class="p">,</span>
                <span class="s">'KeyType'</span><span class="p">:</span> <span class="s">'HASH'</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">],</span>
        <span class="n">AttributeDefinitions</span><span class="o">=</span><span class="p">[</span>
            <span class="p">{</span>
                <span class="s">'AttributeName'</span><span class="p">:</span> <span class="s">'PartitionKey'</span><span class="p">,</span>
                <span class="s">'AttributeType'</span><span class="p">:</span> <span class="s">'S'</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">],</span>
        <span class="n">StreamSpecification</span><span class="o">=</span><span class="p">{</span>
            <span class="s">'StreamEnabled'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
            <span class="s">'StreamViewType'</span><span class="p">:</span> <span class="s">'NEW_AND_OLD_IMAGES'</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
    
<span class="k">def</span> <span class="nf">get_dynamodb_stream_arns</span><span class="p">(</span><span class="n">table_name</span><span class="p">):</span>
    <span class="s">"""Gets DynamoDB Stream ARNs for a table"""</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">ddb_streams_client</span><span class="p">.</span><span class="n">list_streams</span><span class="p">(</span>
        <span class="n">TableName</span><span class="o">=</span><span class="n">table_name</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s">"StreamArn"</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s">"Streams"</span><span class="p">]]</span>
</code></pre></div></div>

<p>S3:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">create_s3_bucket</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="s">"""Creates an S3 bucket"""</span>
    <span class="k">return</span> <span class="n">s3_client</span><span class="p">.</span><span class="n">create_bucket</span><span class="p">(</span>
        <span class="n">Bucket</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></div>

<p>IAM:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">create_iam_role</span><span class="p">(</span><span class="n">role</span><span class="p">,</span> <span class="n">document</span><span class="p">):</span>
    <span class="s">"""Creates an IAM role"""</span>
    <span class="k">return</span> <span class="n">iam_client</span><span class="p">.</span><span class="n">create_role</span><span class="p">(</span>
        <span class="n">RoleName</span><span class="o">=</span><span class="n">role</span><span class="p">,</span>
        <span class="n">AssumeRolePolicyDocument</span><span class="o">=</span><span class="n">read_policy_document</span><span class="p">(</span><span class="n">document</span><span class="p">)</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">put_role_policy</span><span class="p">(</span><span class="n">role</span><span class="p">,</span> <span class="n">policy</span><span class="p">,</span> <span class="n">document</span><span class="p">):</span>
    <span class="s">"""Adds or updates an inline policy document that is embedded in 
    the specified IAM role.
    """</span>
    <span class="k">return</span> <span class="n">iam_client</span><span class="p">.</span><span class="n">put_role_policy</span><span class="p">(</span>
        <span class="n">RoleName</span><span class="o">=</span><span class="n">role</span><span class="p">,</span>
        <span class="n">PolicyName</span><span class="o">=</span><span class="n">policy</span><span class="p">,</span>
        <span class="n">PolicyDocument</span><span class="o">=</span><span class="n">read_policy_document</span><span class="p">(</span><span class="n">document</span><span class="p">)</span>
    <span class="p">)</span>
</code></pre></div></div>

<p>and Lambda:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">create_lambda_funcion</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">env_variables</span><span class="p">):</span>
    <span class="s">"""Creates a Lambda function"""</span>
    <span class="n">shutil</span><span class="p">.</span><span class="n">make_archive</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="s">"zip"</span><span class="p">,</span> <span class="s">"."</span><span class="p">,</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">function</span><span class="si">}</span><span class="s">.py"</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">function</span><span class="si">}</span><span class="s">.zip"</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">zipped_code</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">lambda_client</span><span class="p">.</span><span class="n">create_function</span><span class="p">(</span>
        <span class="n">FunctionName</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
        <span class="n">Runtime</span><span class="o">=</span><span class="s">'python3.8'</span><span class="p">,</span>
        <span class="n">Role</span><span class="o">=</span><span class="n">role</span><span class="p">[</span><span class="s">'Role'</span><span class="p">][</span><span class="s">'Arn'</span><span class="p">],</span>
        <span class="n">Handler</span><span class="o">=</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">function</span><span class="si">}</span><span class="s">.handler'</span><span class="p">,</span>
        <span class="n">Code</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">ZipFile</span><span class="o">=</span><span class="n">zipped_code</span><span class="p">),</span>
        <span class="n">Environment</span><span class="o">=</span><span class="p">{</span>
            <span class="s">'Variables'</span><span class="p">:</span> <span class="n">env_variables</span>
        <span class="p">},</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">create_lambda_event_source_mapping</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">lambda_client</span><span class="p">.</span><span class="n">create_event_source_mapping</span><span class="p">(</span>
        <span class="n">FunctionName</span><span class="o">=</span><span class="n">function</span><span class="p">,</span>
        <span class="n">EventSourceArn</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></div>

<p>Finally, we can combine all of them and create the application:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">create_s3_bucket</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">"test-bucket"</span><span class="p">)</span>
    <span class="n">create_dynamodb_table</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="s">"TestTable"</span><span class="p">)</span>
    <span class="n">stream_arn</span> <span class="o">=</span> <span class="n">get_dynamodb_stream_arns</span><span class="p">(</span><span class="s">"TestTable"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">role</span> <span class="o">=</span> <span class="n">create_iam_role</span><span class="p">(</span>
        <span class="n">role</span><span class="o">=</span><span class="s">"LambdaRole"</span><span class="p">,</span> 
        <span class="n">document</span><span class="o">=</span><span class="s">"trust-relationship.json"</span>
    <span class="p">)</span>
    <span class="n">put_role_policy</span><span class="p">(</span>
        <span class="n">role</span><span class="o">=</span><span class="s">"LambdaRole"</span><span class="p">,</span> 
        <span class="n">policy</span><span class="o">=</span><span class="s">"LambdaRolePolicy"</span><span class="p">,</span> 
        <span class="n">document</span><span class="o">=</span><span class="s">"role-policy.json"</span>
    <span class="p">)</span>
    <span class="n">create_lambda_funcion</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s">"TestLambda"</span><span class="p">,</span> 
        <span class="n">role</span><span class="o">=</span><span class="n">role</span><span class="p">,</span> 
        <span class="n">function</span><span class="o">=</span><span class="s">"lambda_handler"</span><span class="p">,</span> 
        <span class="n">env_variables</span><span class="o">=</span><span class="p">{</span><span class="s">"BUCKET_NAME"</span><span class="p">:</span> <span class="s">"test-bucket"</span><span class="p">}</span>
    <span class="p">)</span>
    <span class="n">create_lambda_event_source_mapping</span><span class="p">(</span>
        <span class="n">function</span><span class="o">=</span><span class="s">"TestLambda"</span><span class="p">,</span> 
        <span class="n">source</span><span class="o">=</span><span class="n">stream_arn</span>
    <span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div></div>

<p>The only thing that is left is to test it and see if we get what we expect. 
We first insert a new item in the DynamoDB table then wait for the DynamoDB 
Stream and the Lambda function to process the event and finally read from an 
S3 file.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">boto3</span>


<span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="s">"AWS_SECRET_ACCESS_KEY"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"something"</span>
<span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="s">"AWS_ACCESS_KEY_ID"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"something"</span>
<span class="n">ENDPOINT_URL</span> <span class="o">=</span> <span class="s">"http://localhost:4566"</span>
<span class="n">AWS_REGION</span> <span class="o">=</span> <span class="s">"us-west-1"</span>


<span class="k">def</span> <span class="nf">get_boto3_client</span><span class="p">(</span><span class="n">service</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">boto3</span><span class="p">.</span><span class="n">client</span><span class="p">(</span>
        <span class="n">service</span><span class="p">,</span>
        <span class="n">region_name</span><span class="o">=</span><span class="n">AWS_REGION</span><span class="p">,</span> 
        <span class="n">endpoint_url</span><span class="o">=</span><span class="n">ENDPOINT_URL</span>
    <span class="p">)</span>

<span class="n">s3_client</span> <span class="o">=</span> <span class="n">get_boto3_client</span><span class="p">(</span><span class="s">"s3"</span><span class="p">)</span>
<span class="n">ddb_client</span> <span class="o">=</span> <span class="n">get_boto3_client</span><span class="p">(</span><span class="s">"dynamodb"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">ddb_client</span><span class="p">.</span><span class="n">put_item</span><span class="p">(</span>
        <span class="n">TableName</span><span class="o">=</span><span class="s">"TestTable"</span><span class="p">,</span>
        <span class="n">Item</span><span class="o">=</span> <span class="p">{</span>
            <span class="s">"PartitionKey"</span><span class="p">:</span> <span class="p">{</span><span class="s">"S"</span><span class="p">:</span> <span class="s">"test-key"</span><span class="p">},</span>
            <span class="s">"Value"</span><span class="p">:</span> <span class="p">{</span><span class="s">"S"</span><span class="p">:</span> <span class="s">"test-value"</span><span class="p">},</span>
        <span class="p">},</span>
    <span class="p">)</span>
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># wait for the stream and lambda
</span>    <span class="n">ddb_client</span><span class="p">.</span><span class="n">scan</span><span class="p">(</span>
        <span class="n">TableName</span><span class="o">=</span><span class="s">"TestTable"</span>
    <span class="p">)</span>
    <span class="n">s3_objects</span> <span class="o">=</span> <span class="n">s3_client</span><span class="p">.</span><span class="n">list_objects</span><span class="p">(</span>
        <span class="n">Bucket</span><span class="o">=</span><span class="s">"test-bucket"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">item_key</span> <span class="o">=</span> <span class="n">s3_objects</span><span class="p">[</span><span class="s">"Contents"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">"Key"</span><span class="p">]</span>
    <span class="n">s3_file</span> <span class="o">=</span> <span class="n">s3_client</span><span class="p">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="s">"test-bucket"</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="n">item_key</span><span class="p">)</span>
    <span class="n">pprint</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">s3_file</span><span class="p">[</span><span class="s">"Body"</span><span class="p">].</span><span class="n">read</span><span class="p">().</span><span class="n">decode</span><span class="p">(</span><span class="s">"utf-8"</span><span class="p">)))</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div></div>

<p>The output should look like:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{'awsRegion': 'us-west-1',
 'dynamodb': {'ApproximateCreationDateTime': 1646044849.2324855,
              'Keys': {'PartitionKey': {'S': 'test-key'}},
              'NewImage': {'PartitionKey': {'S': 'test-key'},
                           'Value': {'S': 'test-value'}},
              'SequenceNumber': '1',
              'SizeBytes': 65,
              'StreamViewType': 'NEW_AND_OLD_IMAGES'},
 'eventID': 'c4b9cd19',
 'eventName': 'INSERT',
 'eventSource': 'aws:dynamodb',
 'eventSourceARN': 'arn:aws:dynamodb:us-west-1:000000000000:table/TestTable',
 'eventVersion': '1.1'}
</code></pre></div></div>

<p>which is what we expected.</p>

<h2 id="resources">Resources</h2>

<ul>
  <li><a href="https://boto3.amazonaws.com/v1/documentation/api/latest/index.html">Boto3 Documentation</a></li>
  <li><a href="https://docs.aws.amazon.com/cli/latest/index.html">AWS CLI Command Reference</a></li>
  <li><a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Streams.Lambda.html">DynamoDB Streams and AWS Lambda Triggers</a></li>
  <li><a href="https://docs.localstack.cloud/overview/">Localstack Documentation</a></li>
</ul>
