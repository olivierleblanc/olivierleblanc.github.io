<div class="figure-div">
    <figure>
        
        <img src="/assets/images/posts/dicom-playground/dicom-playground.jpg" alt="dicom-basics-header" />
        
        
            <figcaption><a href="https://technologyadvice.com/blog/healthcare/5-dicom-viewers/" target="_blank">Image Source</a></figcaption>
        
    </figure>
</div>

<p>We’ll explore some open source libraries in different programming languages and 
how you can use them to process DICOM files. We’ll cover the basics of removing, 
modifying, adding data elements, changing compression, creating DICOM 
files for testing, and masking parts of images for de-identification purposes.</p>

<p>If you are new to the DICOM Standard and you are not sure how the DICOM file 
format works, please read.</p>

<blockquote>
  <p><strong>Disclaimer</strong>: Everything presented here is part of public knowledge and can 
be found in referenced material.</p>
</blockquote>

<h2 id="open-source-libraries">Open Source Libraries</h2>

<p>The following are some of the popular open source libraries for processing DICOM 
files:</p>

<ul>
  <li><a href="https://www.pixelmed.com/" target="_blank">PixelMed</a> - Java DICOM Toolkit 
which is a stand-alone DICOM toolkit that implements code for 
reading and creating DICOM data, DICOM network and file support, support for 
display of images, reports, and much much more</li>
  <li><a href="https://github.com/pydicom/pydicom" target="_blank">pydicom</a> - Pure Python 
package for working with DICOM files. It lets you read, modify and write 
DICOM data in an easy “pythonic” way.</li>
  <li><a href="https://sourceforge.net/projects/gdcm/" target="_blank">Grassroots DICOM (GDCM)</a> - 
Cross-platform library written in C++ for DICOM medical files. It is 
automatically wrapped to Python/C#/Java and PHP which allows you to use the 
language you are familiar with and to integrate it with other applications.</li>
  <li><a href="https://github.com/cornerstonejs/dicomParser" target="_blank">dicomParser</a> - 
Lightweight library for parsing DICOM in modern HTML5 based web browsers. 
dicomParser is fast, easy to use and has no required external dependencies.</li>
  <li><a href="https://dicom.offis.de/dcmtk.php.en" target="_blank">DCMTK</a> - is a 
collection of libraries and applications implementing large parts the DICOM 
standard. It includes software for examining, constructing and converting 
DICOM image files, handling offline media, sending and receiving images over 
a network connection, as well as demonstrative image storage and worklist 
servers. DCMTK is written in a mixture of ANSI C and C++.</li>
</ul>

<p>The choice depends on your use case and, of course, on the language you are 
comfortable with.</p>

<p>These libraries implement most of the things from the DICOM Standard and there 
is no way I can cover all of them in this article. Therefore, we will focus only 
on the PixelMed, pydicom, some of GDCM tools, and switch between them to implement 
different functionalities.</p>

<h2 id="setup">Setup</h2>

<h3 id="pixelmed">PixelMed</h3>

<p>PixelMed is written in Java, so you’ll need Java 1.8 or higher. After you 
install Java, go to <a href="https://www.dclunie.com/pixelmed/software/index.html" target="_blank">PixelMed Directory Tree</a>, 
select the current edition, and download the <code class="language-plaintext highlighter-rouge">pixelmed.jar</code> (or use Maven/Gradle 
if you are familiar with them).</p>

<p>If you are not sure how to use this jar, I suggest you download 
<a href="https://www.eclipse.org/downloads/" target="_blank">Eclipse IDE</a>, 
create a Java project and add <code class="language-plaintext highlighter-rouge">pixelmed.jar</code> to the project, see: 
<a href="https://stackoverflow.com/questions/3280353/how-to-import-a-jar-in-eclipse" target="_blank">How to import a jar in Eclipse</a>.</p>

<p>PixelMed’s API documentation can be found at <a href="https://www.dclunie.com/pixelmed/software/javadoc/index.html" target="_blank">PixelMed JavaDocs</a>.</p>

<h3 id="gdcm">GDCM</h3>

<p>Source code: <a href="https://sourceforge.net/projects/gdcm/" target="_blank">Grassroots DICOM</a>.</p>

<p>There are premade tools which you can use:</p>
<ul>
  <li><strong>gdcmdump</strong> - dumps a DICOM file, it will display the structure and values 
contained in the specified DICOM file.</li>
  <li><strong>gdcmanon</strong> - tool to anonymize a DICOM file.</li>
  <li><strong>gdcmdiff</strong> - dumps differences of two DICOM files</li>
  <li><strong>gdcmconv</strong> - tool to convert DICOM to DICOM etc</li>
</ul>

<p>To use them you can either compile the source or download the binaries from 
<a href="https://github.com/malaterre/GDCM/releases" target="_blank">GDCM Releases</a>.</p>

<blockquote>
  <p>If you are on Linux, you’ll have to add the gdcm <code class="language-plaintext highlighter-rouge">lib</code> folder to 
<code class="language-plaintext highlighter-rouge">/etc/ld.so.conf</code> file or create new <code class="language-plaintext highlighter-rouge">.conf</code> in folder <code class="language-plaintext highlighter-rouge">.d</code>. Then 
run <code class="language-plaintext highlighter-rouge">sudo ldconfig</code>. In order to have gdcm applications available in the 
terminal as commands you’ll have to add <code class="language-plaintext highlighter-rouge">bin</code> to <code class="language-plaintext highlighter-rouge">$PATH</code> 
(globally or in <code class="language-plaintext highlighter-rouge">~/.bash_profile</code>).</p>
</blockquote>

<h3 id="pydicom">pydicom</h3>

<p>This library requires python &gt;= 3.6.1. I suggest you set up a virtual 
environment where you can install packages using a dependency manager (<a href="https://python-poetry.org/" target="_blank">poetry</a>, 
<a href="https://pipenv.pypa.io/en/latest/" target="_blank">pipenv</a>, 
or any other).</p>

<p>To get familiar with the library, please see: 
<a href="https://pydicom.github.io/pydicom/stable/" target="_blank">pydicom documentation</a>.</p>

<h2 id="dicom">DICOM</h2>

<h3 id="exploring-structure">Exploring Structure</h3>

<h4 id="gdcm-1">GDCM</h4>

<p>To explore the structure of a DICOM file, we can use <code class="language-plaintext highlighter-rouge">gdcmdump</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdcmdump &lt;path-to-dicom-file&gt;
</code></pre></div></div>

<p>This will give us an output like:</p>

<p><a name="dicom-file-in-explicit"></a></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Dicom-File-Format

# Dicom-Meta-Information-Header
# Used TransferSyntax: 
(0002,0000) UL 194                                                # 4,1 File Meta Information Group Length
(0002,0001) OB 00\01                                              # 2,1 File Meta Information Version
(0002,0002) UI [1.2.840.10008.5.1.4.1.1.12.2]                     # 28,1 Media Storage SOP Class UID
(0002,0003) UI [1.3.6.1.4.1.5962.1.1.0.0.0.1168612284.20369.0.3]         # 48,1 Media Storage SOP Instance UID
(0002,0010) UI [1.2.840.10008.1.2.1]                              # 20,1 Transfer Syntax UID
(0002,0012) UI [1.3.6.1.4.1.5962.2]                               # 18,1 Implementation Class UID
(0002,0013) SH [DCTOOL100 ]                                       # 10,1 Implementation Version Name
(0002,0016) AE [CLUNIE1 ]                                         # 8,1 Source Application Entity Title

# Dicom-Data-Set
# Used TransferSyntax: 1.2.840.10008.1.2.1
(0008,0005) CS [ISO_IR 100]                                       # 10,1-n Specific Character Set
(0008,0008) CS [ORIGINAL\PRIMARY\SINGLE PLANE ]                   # 30,2-n Image Type
(0008,0012) DA [20070112]                                         # 8,1 Instance Creation Date
(0008,0013) TM [093126]                                           # 6,1 Instance Creation Time
(0008,0014) UI [1.3.6.1.4.1.5962.3]                               # 18,1 Instance Creator UID
(0008,0016) UI [1.2.840.10008.5.1.4.1.1.12.2]                     # 28,1 SOP Class UID
(0008,0018) UI [1.3.6.1.4.1.5962.1.1.0.0.0.1168612284.20369.0.3]         # 48,1 SOP Instance UID
...
</code></pre></div></div>

<p>This tool offers a quick and easy way to explore DICOM files and debug 
applications that process DICOM files.</p>

<p>Looking at the output we can see the <em>Dicom-Meta-Information-Header</em> and 
<em>Dicom-Data-Set</em>. Additionally, for each Data Element, we have a Tag 
<code class="language-plaintext highlighter-rouge">(gggg,eeee)</code> then a VR, followed by a Value, and the information after <code class="language-plaintext highlighter-rouge">#</code> 
represents: VL, VM, and Tag Name.</p>

<p><code class="language-plaintext highlighter-rouge">gdcmdump</code> comes with a lot of options that you can use to generate an output, 
for more information please see: <a href="http://gdcm.sourceforge.net/html/gdcmdump.html" target="_blank">gdcmdump</a></p>

<h4 id="pixelmed-1">PixelMed</h4>

<p>The <code class="language-plaintext highlighter-rouge">AttributeList</code> class is a class in the PixelMed that maintains a list of 
individual DICOM attributes. It could be used to get the structure of a file, 
modify it, and save it.</p>

<p>Using <code class="language-plaintext highlighter-rouge">.read(java.lang.String name)</code> we can read the tags:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">pixelmed_demo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.pixelmed.dicom.AttributeList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.pixelmed.dicom.DicomException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">demo_main</span> <span class="o">{</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">String</span> <span class="n">filepath</span> <span class="o">=</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
		<span class="nc">AttributeList</span> <span class="n">attList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AttributeList</span><span class="o">();</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="n">attList</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">filepath</span><span class="o">);</span>
			<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">attList</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="o">|</span> <span class="nc">DicomException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Oops! Error: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Passing the same DICOM file we used in <code class="language-plaintext highlighter-rouge">gdcmdump</code> example as an argument, 
we get:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(0x0002,0x0000) FileMetaInformationGroupLength VR=&lt;UL&gt; VL=&lt;0x4&gt; [0xc2]
(0x0002,0x0001) FileMetaInformationVersion VR=&lt;OB&gt; VL=&lt;0x2&gt; []
(0x0002,0x0002) MediaStorageSOPClassUID VR=&lt;UI&gt; VL=&lt;0x1c&gt; &lt;1.2.840.10008.5.1.4.1.1.12.2&gt;
(0x0002,0x0003) MediaStorageSOPInstanceUID VR=&lt;UI&gt; VL=&lt;0x30&gt; &lt;1.3.6.1.4.1.5962.1.1.0.0.0.1168612284.20369.0.3&gt;
(0x0002,0x0010) TransferSyntaxUID VR=&lt;UI&gt; VL=&lt;0x14&gt; &lt;1.2.840.10008.1.2.1&gt;
(0x0002,0x0012) ImplementationClassUID VR=&lt;UI&gt; VL=&lt;0x12&gt; &lt;1.3.6.1.4.1.5962.2&gt;
(0x0002,0x0013) ImplementationVersionName VR=&lt;SH&gt; VL=&lt;0xa&gt; &lt;DCTOOL100 &gt;
(0x0002,0x0016) SourceApplicationEntityTitle VR=&lt;AE&gt; VL=&lt;0x8&gt; &lt;CLUNIE1 &gt;
(0x0008,0x0005) SpecificCharacterSet VR=&lt;CS&gt; VL=&lt;0xa&gt; &lt;ISO_IR 100&gt;
(0x0008,0x0008) ImageType VR=&lt;CS&gt; VL=&lt;0x1e&gt; &lt;ORIGINAL\PRIMARY\SINGLE PLANE &gt;
(0x0008,0x0012) InstanceCreationDate VR=&lt;DA&gt; VL=&lt;0x8&gt; &lt;20070112&gt;
(0x0008,0x0013) InstanceCreationTime VR=&lt;TM&gt; VL=&lt;0x6&gt; &lt;093126&gt;
(0x0008,0x0014) InstanceCreatorUID VR=&lt;UI&gt; VL=&lt;0x12&gt; &lt;1.3.6.1.4.1.5962.3&gt;
(0x0008,0x0016) SOPClassUID VR=&lt;UI&gt; VL=&lt;0x1c&gt; &lt;1.2.840.10008.5.1.4.1.1.12.2&gt;
(0x0008,0x0018) SOPInstanceUID VR=&lt;UI&gt; VL=&lt;0x30&gt; &lt;1.3.6.1.4.1.5962.1.1.0.0.0.1168612284.20369.0.3&gt;
...
</code></pre></div></div>

<p>which gives the same output as <code class="language-plaintext highlighter-rouge">gdcmdump</code> but in a different format.</p>

<h3 id="remove-data-element">Remove Data Element</h3>

<p>Let’s try to remove the <em>InstanceCreatorUID</em> <code class="language-plaintext highlighter-rouge">(0008,0014)</code> from the Data Set and 
save the DICOM object as a new file.</p>

<h4 id="pixelmed-2">PixelMed</h4>

<p>The <code class="language-plaintext highlighter-rouge">AttributeList</code> has a lot of options for manipulating Data Sets, 
we can remove a whole group, all private tags, specific tag etc.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">pixelmed_demo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.pixelmed.dicom.AttributeList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.pixelmed.dicom.AttributeTag</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.pixelmed.dicom.Attribute</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.pixelmed.dicom.DicomException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">demo_main</span> <span class="o">{</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">String</span> <span class="n">filepath</span> <span class="o">=</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
		<span class="nc">AttributeList</span> <span class="n">attList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AttributeList</span><span class="o">();</span>
		<span class="nc">AttributeTag</span> <span class="n">instanceCreatorTag</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AttributeTag</span><span class="o">(</span><span class="mh">0x0008</span><span class="o">,</span> <span class="mh">0x0014</span><span class="o">);</span>
		<span class="nc">AttributeTag</span> <span class="n">transferSyntaxTag</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AttributeTag</span><span class="o">(</span><span class="mh">0x0002</span><span class="o">,</span> <span class="mh">0x0010</span><span class="o">);</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="c1">// Read DICOM</span>
			<span class="n">attList</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">filepath</span><span class="o">);</span>

			<span class="c1">// Get TransferSyntaxUID</span>
			<span class="nc">Attribute</span> <span class="n">transferSyntaxAtt</span> <span class="o">=</span> <span class="n">attList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">transferSyntaxTag</span><span class="o">);</span>
			<span class="nc">String</span> <span class="n">transferSyntaxUID</span> <span class="o">=</span> <span class="n">transferSyntaxAtt</span><span class="o">.</span><span class="na">getSingleStringValueOrEmptyString</span><span class="o">();</span>

			<span class="c1">// Remove Tag</span>
			<span class="n">attList</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">instanceCreatorTag</span><span class="o">);</span>
			
			<span class="c1">// Write DICOM</span>
			<span class="n">attList</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"test.dcm"</span><span class="o">,</span> <span class="n">transferSyntaxUID</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="o">|</span> <span class="nc">DicomException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Oops! Error: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>This will output a new DICOM file <code class="language-plaintext highlighter-rouge">test.dcm</code> which doesn’t contain the
<em>InstanceCreatorUID</em>.</p>

<p>To confirm this we can run <strong>gdcmdiff</strong> which dumps the difference between two 
DICOM files:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdcmdiff &lt;path_to_new_file&gt; &lt;path_to_old_file&gt;
</code></pre></div></div>

<p>The output is:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(0008,0014) UI [only file 2] [1.3.6.1.4.1.5962.3] # Instance Creator UID
               -------------
</code></pre></div></div>

<p>as expected.</p>

<p>You may notice that as we deal with many attributes, defining a specific tag as:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">AttributeTag</span> <span class="n">transferSyntaxTag</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AttributeTag</span><span class="o">(</span><span class="mh">0x0002</span><span class="o">,</span> <span class="mh">0x0010</span><span class="o">);</span>
</code></pre></div></div>

<p>becomes tedious. Fortunately, there are better ways. One of them is to use the
<code class="language-plaintext highlighter-rouge">TagFromName</code> which contains constants that map names to tags, and the other 
is to use the <code class="language-plaintext highlighter-rouge">DicomDictionary</code> to do a lookup:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Using TagFromName</span>
<span class="nc">AttributeTag</span> <span class="n">transferSyntaxTag</span> <span class="o">=</span> <span class="nc">TagFromName</span><span class="o">.</span><span class="na">TransferSyntaxUID</span><span class="o">;</span>

<span class="c1">// Using DicomDictionary</span>
<span class="nc">AttributeTag</span> <span class="n">transferSyntaxTag</span> <span class="o">=</span> <span class="nc">DicomDictionary</span><span class="o">.</span><span class="na">StandardDictionary</span><span class="o">.</span><span class="na">getTagFromName</span><span class="o">(</span><span class="s">"TransferSyntaxUID"</span><span class="o">)</span>
</code></pre></div></div>

<h4 id="pydicom-1">pydicom</h4>

<p>Let’s do the same using the pydicom. To do this, we will use the <code class="language-plaintext highlighter-rouge">dcmread</code> to 
read a DICOM file which returns a <code class="language-plaintext highlighter-rouge">FileDataset</code> instance that we can edit and 
then save.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pydicom</span> <span class="kn">import</span> <span class="n">dcmread</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"&lt;path-to-dicom-file&gt;"</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_in</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">dcmread</span><span class="p">(</span><span class="n">f_in</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">ds</span><span class="p">.</span><span class="n">InstanceCreatorUID</span>
    <span class="n">ds</span><span class="p">.</span><span class="n">save_as</span><span class="p">(</span><span class="s">"test.dcm"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="modifyadd-data-element">Modify/Add Data Element</h3>

<h4 id="pixelmed-3">PixelMed</h4>

<p>To modify/add a Data Element to the Data Set, we create an <code class="language-plaintext highlighter-rouge">AttributeList</code> 
instance and an <code class="language-plaintext highlighter-rouge">Attribute</code> instance, then put the attribute to the list:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">pixelmed_demo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.pixelmed.dicom.AttributeList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.pixelmed.dicom.AttributeTag</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.pixelmed.dicom.Attribute</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.pixelmed.dicom.DicomException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.pixelmed.dicom.TagFromName</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.pixelmed.dicom.PersonNameAttribute</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.pixelmed.dicom.CodeStringAttribute</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">demo_main</span> <span class="o">{</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">String</span> <span class="n">filepath</span> <span class="o">=</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
		<span class="nc">AttributeList</span> <span class="n">attList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AttributeList</span><span class="o">();</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="c1">// Read DICOM</span>
			<span class="n">attList</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">filepath</span><span class="o">);</span>

			<span class="c1">// Get TransferSyntaxUID</span>
			<span class="nc">Attribute</span> <span class="n">transferSyntaxAtt</span> <span class="o">=</span> <span class="n">attList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="nc">TagFromName</span><span class="o">.</span><span class="na">TransferSyntaxUID</span><span class="o">);</span>
			<span class="nc">String</span> <span class="n">transferSyntaxUID</span> <span class="o">=</span> <span class="n">transferSyntaxAtt</span><span class="o">.</span><span class="na">getSingleStringValueOrEmptyString</span><span class="o">();</span>
			
			<span class="c1">// Modify Existing Tag</span>
			<span class="nc">Attribute</span> <span class="n">patientName</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PersonNameAttribute</span><span class="o">(</span><span class="nc">TagFromName</span><span class="o">.</span><span class="na">PatientName</span><span class="o">);</span>
			<span class="n">patientName</span><span class="o">.</span><span class="na">addValue</span><span class="o">(</span><span class="s">"TestName"</span><span class="o">);</span>
			<span class="n">attList</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">TagFromName</span><span class="o">.</span><span class="na">PatientName</span><span class="o">,</span> <span class="n">patientName</span><span class="o">);</span>

			<span class="c1">// Add New Tag</span>
			<span class="nc">Attribute</span> <span class="n">newAtt</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CodeStringAttribute</span><span class="o">(</span><span class="k">new</span> <span class="nc">AttributeTag</span><span class="o">(</span><span class="mh">0x0011</span><span class="o">,</span> <span class="mh">0x0010</span><span class="o">));</span>
			<span class="n">newAtt</span><span class="o">.</span><span class="na">addValue</span><span class="o">(</span><span class="s">"SomeRandomString"</span><span class="o">);</span>
			<span class="n">attList</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">newAtt</span><span class="o">);</span>
			
			<span class="c1">// Write DICOM</span>
			<span class="n">attList</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"test.dcm"</span><span class="o">,</span> <span class="n">transferSyntaxUID</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="o">|</span> <span class="nc">DicomException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Oops! Error: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>This will create a new DICOM file with modified <em>PatientName</em> tag and a new tag 
<code class="language-plaintext highlighter-rouge">(0011,0010)</code>. If we use <strong>gdcmdiff</strong> to check the differences between the old 
and the new file, we get exactly what we expect:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(0010,0010) PN [from file 1] [TestName] # Patient's Name
(0010,0010) PN [from file 2] [Test^FluroWithDisplayShutter] # Patient's Name
               -------------
(0011,0010) CS [only file 1] [SomeRandomString] # Private Creator
               -------------
</code></pre></div></div>

<h4 id="pydicom-2">pydicom</h4>

<p>To do the same in python:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pydicom</span> <span class="kn">import</span> <span class="n">dcmread</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"&lt;path-to-dicom-file&gt;"</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_in</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">dcmread</span><span class="p">(</span><span class="n">f_in</span><span class="p">)</span>
    
    <span class="c1"># Modify Existing Tag
</span>    <span class="n">ds</span><span class="p">.</span><span class="n">PatientName</span> <span class="o">=</span> <span class="s">"TestName"</span>

    <span class="c1"># Add New Tag
</span>    <span class="n">ds</span><span class="p">.</span><span class="n">add_new</span><span class="p">([</span><span class="mh">0x0011</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">],</span> <span class="s">"CS"</span><span class="p">,</span> <span class="s">"SomeRandomString"</span><span class="p">)</span>

    <span class="c1"># Write DICOM
</span>    <span class="n">ds</span><span class="p">.</span><span class="n">save_as</span><span class="p">(</span><span class="s">"test.dcm"</span><span class="p">)</span>
</code></pre></div></div>

<p>which gives use the same result.</p>

<p>If we want to add a tag from the DICOM Standard but we are not sure about its 
VR, we can use the <code class="language-plaintext highlighter-rouge">dictionary_VR</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">pydicom.datadict</span> <span class="kn">import</span> <span class="n">dictionary_VR</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">dictionary_VR</span><span class="p">([</span><span class="mh">0x0028</span><span class="p">,</span> <span class="mh">0x1050</span><span class="p">])</span>
<span class="s">'DS'</span>
</code></pre></div></div>

<h3 id="add-nested-data-element">Add Nested Data Element</h3>

<p>Let’s add a private nested data element that contains two items which contain 
the same private attributes but with different values. The process is the same 
for the tags from the DICOM Standard.</p>

<h4 id="pixelmed-4">PixelMed</h4>

<p>To add a nested tag using the PixelMed, we have to define a <code class="language-plaintext highlighter-rouge">SequenceAttribute</code>. 
This attribute will contain Sequence Items which we create using the 
<code class="language-plaintext highlighter-rouge">AttributeList</code>. After adding Data Elements to the <code class="language-plaintext highlighter-rouge">AttributeList</code> we add the list 
to the <code class="language-plaintext highlighter-rouge">SequenceAttribute</code> using <code class="language-plaintext highlighter-rouge">addItem(AttributeList item)</code>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">pixelmed_demo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.pixelmed.dicom.AttributeList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.pixelmed.dicom.AttributeTag</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.pixelmed.dicom.Attribute</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.pixelmed.dicom.DicomException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.pixelmed.dicom.TagFromName</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.pixelmed.dicom.SequenceAttribute</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.pixelmed.dicom.CodeStringAttribute</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.pixelmed.dicom.DateAttribute</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">demo_main</span> <span class="o">{</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">String</span> <span class="n">filepath</span> <span class="o">=</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
		<span class="nc">AttributeList</span> <span class="n">attList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AttributeList</span><span class="o">();</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="c1">// Read DICOM</span>
			<span class="n">attList</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">filepath</span><span class="o">);</span>

			<span class="c1">// Get TransferSyntaxUID</span>
			<span class="nc">Attribute</span> <span class="n">transferSyntaxAtt</span> <span class="o">=</span> <span class="n">attList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="nc">TagFromName</span><span class="o">.</span><span class="na">TransferSyntaxUID</span><span class="o">);</span>
			<span class="nc">String</span> <span class="n">transferSyntaxUID</span> <span class="o">=</span> <span class="n">transferSyntaxAtt</span><span class="o">.</span><span class="na">getSingleStringValueOrEmptyString</span><span class="o">();</span>
	
			<span class="c1">// Sequence Attribute</span>
			<span class="nc">SequenceAttribute</span> <span class="n">seq</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SequenceAttribute</span><span class="o">(</span><span class="k">new</span> <span class="nc">AttributeTag</span><span class="o">(</span><span class="mh">0x0011</span><span class="o">,</span> <span class="mh">0x0010</span><span class="o">));</span>
			
			<span class="c1">// Sequence Item 1</span>
			<span class="nc">AttributeList</span> <span class="n">seqItemOne</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AttributeList</span><span class="o">();</span>
			<span class="nc">Attribute</span> <span class="n">attSeqOneOne</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CodeStringAttribute</span><span class="o">(</span><span class="k">new</span> <span class="nc">AttributeTag</span><span class="o">(</span><span class="mh">0x0011</span><span class="o">,</span> <span class="mh">0x0100</span><span class="o">));</span>
			<span class="n">attSeqOneOne</span><span class="o">.</span><span class="na">addValue</span><span class="o">(</span><span class="s">"Sequence One Value"</span><span class="o">);</span>
			<span class="nc">Attribute</span> <span class="n">attSeqOneTwo</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DateAttribute</span><span class="o">(</span><span class="k">new</span> <span class="nc">AttributeTag</span><span class="o">(</span><span class="mh">0x0011</span><span class="o">,</span> <span class="mh">0x0102</span><span class="o">));</span>
			<span class="n">attSeqOneTwo</span><span class="o">.</span><span class="na">addValue</span><span class="o">(</span><span class="s">"2022-01-01"</span><span class="o">);</span>
			<span class="n">seqItemOne</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">attSeqOneOne</span><span class="o">);</span>
			<span class="n">seqItemOne</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">attSeqOneTwo</span><span class="o">);</span>
			
			<span class="c1">// Sequence Item 2</span>
			<span class="nc">AttributeList</span> <span class="n">seqItemTwo</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AttributeList</span><span class="o">();</span>
			<span class="nc">Attribute</span> <span class="n">attSeqTwoOne</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CodeStringAttribute</span><span class="o">(</span><span class="k">new</span> <span class="nc">AttributeTag</span><span class="o">(</span><span class="mh">0x0011</span><span class="o">,</span> <span class="mh">0x0100</span><span class="o">));</span>
			<span class="n">attSeqTwoOne</span><span class="o">.</span><span class="na">addValue</span><span class="o">(</span><span class="s">"Sequence Two Value"</span><span class="o">);</span>
			<span class="nc">Attribute</span> <span class="n">attSeqTwoTwo</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DateAttribute</span><span class="o">(</span><span class="k">new</span> <span class="nc">AttributeTag</span><span class="o">(</span><span class="mh">0x0011</span><span class="o">,</span> <span class="mh">0x0102</span><span class="o">));</span>
			<span class="n">attSeqTwoTwo</span><span class="o">.</span><span class="na">addValue</span><span class="o">(</span><span class="s">"2022-01-02"</span><span class="o">);</span>
			<span class="n">seqItemTwo</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">attSeqTwoOne</span><span class="o">);</span>
			<span class="n">seqItemTwo</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">attSeqTwoTwo</span><span class="o">);</span>
			
			<span class="c1">// Add Sequence Items</span>
			<span class="n">seq</span><span class="o">.</span><span class="na">addItem</span><span class="o">(</span><span class="n">seqItemOne</span><span class="o">);</span>
			<span class="n">seq</span><span class="o">.</span><span class="na">addItem</span><span class="o">(</span><span class="n">seqItemTwo</span><span class="o">);</span>
			<span class="n">attList</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">seq</span><span class="o">);</span>
			
			<span class="c1">// Write DICOM</span>
			<span class="n">attList</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"test.dcm"</span><span class="o">,</span> <span class="n">transferSyntaxUID</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="o">|</span> <span class="nc">DicomException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Oops! Error: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Each sequence item is a Data Set of its own and for each 
item we create an <code class="language-plaintext highlighter-rouge">AttributeList</code> instance where we add attributes, in the 
end we add these lists as sequence items to a sequence attribute.</p>

<p>If we check the result with <strong>gdcmdump</strong>, we should see:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(0011,0010) SQ (LO) (Sequence with undefined length)              # u/l,1 Private Creator
  (fffe,e000) na (Item with undefined length)
    (0011,0100) CS [Sequence One Value]                           # 18,? (1)  Private Element With Empty Private Creator
    (0011,0102) DA [2022-01-01]                                   # 10,? (1)  Private Element With Empty Private Creator
  (fffe,e00d)
  (fffe,e000) na (Item with undefined length)
    (0011,0100) CS [Sequence Two Value]                           # 18,? (1)  Private Element With Empty Private Creator
    (0011,0102) DA [2022-01-02]                                   # 10,? (1)  Private Element With Empty Private Creator
  (fffe,e00d)
(fffe,e0dd)
</code></pre></div></div>

<p>which is what we wanted.</p>

<h4 id="pydicom-3">pydicom</h4>

<p>The same can be done using the pydicom, here we define a <code class="language-plaintext highlighter-rouge">seq</code> variable that is 
just a list of <code class="language-plaintext highlighter-rouge">Dataset</code> instances, these data sets have the same meaning as 
<code class="language-plaintext highlighter-rouge">AttributeList</code> in the PixelMed. After that we access individual data sets 
i.e. sequence items and add attributes to them:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pydicom</span> <span class="kn">import</span> <span class="n">dcmread</span><span class="p">,</span> <span class="n">Dataset</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"test-dicom-files/image-2.dcm"</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_in</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">dcmread</span><span class="p">(</span><span class="n">f_in</span><span class="p">)</span>
    
    <span class="c1"># Sequence Attribute
</span>    <span class="n">seq</span> <span class="o">=</span> <span class="p">[</span><span class="n">Dataset</span><span class="p">(),</span> <span class="n">Dataset</span><span class="p">()]</span>
    
    <span class="c1"># Sequence Item 1
</span>    <span class="n">seq</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">add_new</span><span class="p">([</span><span class="mh">0x0011</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">],</span> <span class="s">"CS"</span><span class="p">,</span> <span class="s">"Sequence One Value"</span><span class="p">)</span>
    <span class="n">seq</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">add_new</span><span class="p">([</span><span class="mh">0x0011</span><span class="p">,</span> <span class="mh">0x0102</span><span class="p">],</span> <span class="s">"DA"</span><span class="p">,</span> <span class="s">"2021-01-01"</span><span class="p">)</span>

    <span class="c1"># Sequence Item 2
</span>    <span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">add_new</span><span class="p">([</span><span class="mh">0x0011</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">],</span> <span class="s">"CS"</span><span class="p">,</span> <span class="s">"Sequence Two Value"</span><span class="p">)</span>
    <span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">add_new</span><span class="p">([</span><span class="mh">0x0011</span><span class="p">,</span> <span class="mh">0x0102</span><span class="p">],</span> <span class="s">"DA"</span><span class="p">,</span> <span class="s">"2021-01-02"</span><span class="p">)</span>

    <span class="c1"># Add Sequence Attribute
</span>    <span class="n">ds</span><span class="p">.</span><span class="n">add_new</span><span class="p">([</span><span class="mh">0x0011</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">],</span> <span class="s">'SQ'</span><span class="p">,</span> <span class="n">seq</span><span class="p">)</span>

    <span class="c1"># Write DICOM
</span>    <span class="n">ds</span><span class="p">.</span><span class="n">save_as</span><span class="p">(</span><span class="s">"test.dcm"</span><span class="p">)</span>
</code></pre></div></div>

<p>The result is the same as above.</p>

<h3 id="change-transfer-syntax">Change Transfer Syntax</h3>

<p>Let’s first change Explicit to Implicit.</p>

<p>Of course, before writing a new DICOM file, we have to update the information 
about new <em>TransferSyntaxUID</em> and <em>SourceApplicationEntityTitle</em>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">pixelmed_demo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.pixelmed.dicom.AttributeList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.pixelmed.dicom.DicomException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.pixelmed.dicom.TransferSyntax</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.pixelmed.dicom.FileMetaInformation</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">demo_main</span> <span class="o">{</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">String</span> <span class="n">filepath</span> <span class="o">=</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
		<span class="nc">AttributeList</span> <span class="n">attList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AttributeList</span><span class="o">();</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="c1">// Read DICOM	</span>
			<span class="n">attList</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">filepath</span><span class="o">);</span>
			
			<span class="c1">// Update File Meta Information Header</span>
			<span class="nc">FileMetaInformation</span><span class="o">.</span><span class="na">addFileMetaInformation</span><span class="o">(</span><span class="n">attList</span><span class="o">,</span> <span class="nc">TransferSyntax</span><span class="o">.</span><span class="na">ImplicitVRLittleEndian</span><span class="o">,</span> <span class="s">"DicomPlayGround"</span><span class="o">);</span>
			
			<span class="c1">// Write DICOM</span>
			<span class="n">attList</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"test.dcm"</span><span class="o">,</span> <span class="nc">TransferSyntax</span><span class="o">.</span><span class="na">ImplicitVRLittleEndian</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="o">|</span> <span class="nc">DicomException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Oops! Error: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The new file looks like:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Dicom-File-Format

# Dicom-Meta-Information-Header
# Used TransferSyntax: 
(0002,0000) UL 210                                                # 4,1 File Meta Information Group Length
(0002,0001) OB 00\01                                              # 2,1 File Meta Information Version
(0002,0002) UI [1.2.840.10008.5.1.4.1.1.12.2]                     # 28,1 Media Storage SOP Class UID
(0002,0003) UI [1.3.6.1.4.1.5962.1.1.0.0.0.1168612284.20369.0.3]         # 48,1 Media Storage SOP Instance UID
(0002,0010) UI [1.2.840.10008.1.2]                                # 18,1 Transfer Syntax UID
(0002,0012) UI [1.3.6.1.4.1.5962.99.2]                            # 22,1 Implementation Class UID
(0002,0013) SH [PIXELMEDJAVA001 ]                                 # 16,1 Implementation Version Name
(0002,0016) AE [DicomPlayGround ]                                 # 16,1 Source Application Entity Title

# Dicom-Data-Set
# Used TransferSyntax: 1.2.840.10008.1.2
(0008,0005) ?? (CS) [ISO_IR 100]                                  # 10,1-n Specific Character Set
(0008,0008) ?? (CS) [ORIGINAL\PRIMARY\SINGLE PLANE ]              # 30,2-n Image Type
(0008,0012) ?? (DA) [20070112]                                    # 8,1 Instance Creation Date
(0008,0013) ?? (TM) [093126]                                      # 6,1 Instance Creation Time
(0008,0014) ?? (UI) [1.3.6.1.4.1.5962.3]                          # 18,1 Instance Creator UID
(0008,0016) ?? (UI) [1.2.840.10008.5.1.4.1.1.12.2]                # 28,1 SOP Class UID
</code></pre></div></div>

<p>Compare this to the same file in the <a href="#dicom-file-in-explicit">Explicit format</a>, 
the changes are obvious and expected.</p>

<p>However, it’s not so simple if we have compressed pixel data. Depending on the 
compression and wanted output it could be hard to find needed libraries 
that can do the conversion.</p>

<p>The PixelMed relies on Java libraries for compressing and decompressing pixel data. 
You could use <code class="language-plaintext highlighter-rouge">imageIO</code>, the PixelMed’s stand-alone <em>Java JPEG Selective Block 
Redaction Codec and Lossless JPEG Decoder</em>, or any other library, but as far 
as I know, things can get complicated and inefficient for certain 
TransferSyntaxUIDs i.e. compression algorithms.</p>

<p>In my opinion, when it comes to compression, the better option is to use GDCM 
only or GDCM in combination with the pydicom. To get the better understanding 
of supported transfer syntaxes, please see the table at 
<a href="https://pydicom.github.io/pydicom/dev/old/image_data_handlers.html#supported-transfer-syntaxes" target="_blank">Supported Transfer Syntaxes</a>.</p>

<p>For now, we can use <strong>gdcmconv</strong> tool to play with different transfer syntaxes. 
There are a lot of options, and you can explore them at 
<a href="http://gdcm.sourceforge.net/html/gdcmconv.html" target="_blank">gdcmconv</a>.</p>

<p>To convert to JPEG Lossless i.e. <code class="language-plaintext highlighter-rouge">1.2.840.10008.1.2.4.70</code> we can use:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdcmconv <span class="nt">--jpeg</span> <span class="nt">-i</span> &lt;input-file&gt; <span class="nt">-o</span> &lt;output-file&gt;
</code></pre></div></div>

<p>If your input file was uncompressed, you should see a significant loss in 
size of the output file.</p>

<h3 id="create-dicom-from-an-image">Create DICOM from an Image</h3>

<p>Creating a DICOM file from an image can be really useful in many cases. 
Especially, when it comes to testing:</p>
<ul>
  <li>Application should be tested in test/dev environment where you cannot 
use real world scans</li>
  <li>De-identification process that masks certain parts of images should be 
tested for different image resolutions etc.</li>
</ul>

<p>To achieve this you can use the <code class="language-plaintext highlighter-rouge">ImageToDicom</code>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">pixelmed_demo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.pixelmed.dicom.ImageToDicom</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.pixelmed.dicom.DicomException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">demo_main</span> <span class="o">{</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">String</span> <span class="n">filepath</span> <span class="o">=</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="k">new</span> <span class="nf">ImageToDicom</span><span class="o">(</span>
					<span class="n">filepath</span><span class="o">,</span>
					<span class="s">"test.dcm"</span><span class="o">,</span>						<span class="c1">// Output path</span>
					<span class="s">"Vladsiv"</span><span class="o">,</span>						<span class="c1">// Patient Name</span>
					<span class="s">"TEST-98341-VladSiv"</span><span class="o">,</span>			<span class="c1">// Patient ID</span>
					<span class="s">"847542"</span><span class="o">,</span>						<span class="c1">// Study ID</span>
					<span class="s">"1"</span><span class="o">,</span>							<span class="c1">// Series Number</span>
					<span class="s">"1"</span><span class="o">,</span> 							<span class="c1">// Instance Number</span>
					<span class="s">"US"</span><span class="o">,</span>							<span class="c1">// Modality</span>
					<span class="s">"1.2.840.10008.5.1.4.1.1.6.1"</span>	<span class="c1">// SOP Class UID</span>
			<span class="o">);</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="o">|</span> <span class="nc">DicomException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Oops! Error: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The result is:</p>

<div class="figure-div">
    <figure>
        
        <img src="/assets/images/posts/dicom-playground/avatar.png" alt="image-to-dicom" />
        
        
            <figcaption>Image to DICOM MicroDicom Preview</figcaption>
        
    </figure>
</div>

<p>Of course, you can then process the output DICOM file, add/modify data 
elements, and tailor the file for your specific needs.</p>

<p>To do the same using the pydicom, please see this thread: 
<a href="https://github.com/pydicom/pydicom/issues/939" target="_blank">PNG to DICOM with pydicom</a></p>

<h3 id="blackout-image">Blackout Image</h3>

<p>In certain circumstances, we want to blackout certain parts of DICOM images. 
This is usually done to remove the 
<a href="https://en.wikipedia.org/wiki/Protected_health_information" target="_blank">Protected Health Information - PHI</a> 
that can be found on an image.</p>

<p>To do this using the PixelMed we can use the <code class="language-plaintext highlighter-rouge">ImageEditUtilities</code> and the method: 
<code class="language-plaintext highlighter-rouge">blackout(SourceImage srcImg, AttributeList list, java.util.Vector shapes)</code>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">pixelmed_demo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.awt.Shape</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.awt.Rectangle</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Vector</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.pixelmed.display.ImageEditUtilities</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.pixelmed.display.SourceImage</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.pixelmed.dicom.AttributeList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.pixelmed.dicom.Attribute</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.pixelmed.dicom.TagFromName</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">demo_main</span> <span class="o">{</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">String</span> <span class="n">filepath</span> <span class="o">=</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
		<span class="nc">AttributeList</span> <span class="n">attList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AttributeList</span><span class="o">();</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="c1">// Read DICOM file</span>
			<span class="n">attList</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">filepath</span><span class="o">);</span>
			
			<span class="c1">// Get Transfer Syntax</span>
			<span class="nc">Attribute</span> <span class="n">transferSyntaxAtt</span> <span class="o">=</span> <span class="n">attList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="nc">TagFromName</span><span class="o">.</span><span class="na">TransferSyntaxUID</span><span class="o">);</span>
			<span class="nc">String</span> <span class="n">transferSyntaxUID</span> <span class="o">=</span> <span class="n">transferSyntaxAtt</span><span class="o">.</span><span class="na">getSingleStringValueOrEmptyString</span><span class="o">();</span>
			
			<span class="c1">// Create Area to blackout</span>
			<span class="nc">Vector</span><span class="o">&lt;</span><span class="nc">Shape</span><span class="o">&gt;</span> <span class="n">shapes</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Vector</span><span class="o">&lt;</span><span class="nc">Shape</span><span class="o">&gt;();</span>
			<span class="nc">Shape</span> <span class="n">shape</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Rectangle</span><span class="o">(</span><span class="mi">35</span><span class="o">,</span> <span class="mi">60</span><span class="o">,</span> <span class="mi">140</span><span class="o">,</span> <span class="mi">50</span><span class="o">);</span>
			<span class="n">shapes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">shape</span><span class="o">);</span>
			
			<span class="c1">// Define Image and Perform Blackout</span>
			<span class="nc">SourceImage</span> <span class="n">sImg</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SourceImage</span><span class="o">(</span><span class="n">attList</span><span class="o">);</span>
			<span class="nc">ImageEditUtilities</span><span class="o">.</span><span class="na">blackout</span><span class="o">(</span><span class="n">sImg</span><span class="o">,</span> <span class="n">attList</span><span class="o">,</span> <span class="n">shapes</span><span class="o">);</span>
			
			<span class="c1">// Write DICOM</span>
			<span class="n">attList</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"test.dcm"</span><span class="o">,</span> <span class="n">transferSyntaxUID</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
			
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Oops! Error: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>This will give us:</p>

<div class="figure-div">
    <figure>
        
        <img src="/assets/images/posts/dicom-playground/avatarblackout.png" alt="dicom-blackout	" />
        
        
            <figcaption>Blackout MicroDicom Preview</figcaption>
        
    </figure>
</div>

<h2 id="final-words">Final Words</h2>

<p>This article gives a brief introduction to basics of processing DICOM files 
using some of the open source libraries.</p>

<p>There are many awesome libraries and DICOM applications that I didn’t mention 
and I encourage you to go through provided material and play with them on your 
own.</p>

<p>I hope this helps you get a better understanding how you can process DICOM 
files and start building your own DICOM applications.</p>

<p>If you have any questions or suggestions, please reach out, I’m always 
available.</p>
